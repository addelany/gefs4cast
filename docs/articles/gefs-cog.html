<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="gefs4cast">
<title>Cloud-Optimized Geotiff methods for GEFS • gefs4cast</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cloud-Optimized Geotiff methods for GEFS">
<meta property="og:description" content="gefs4cast">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">gefs4cast</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9900</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/gefs-cog.html">Cloud-Optimized Geotiff methods for GEFS</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Cloud-Optimized Geotiff methods for GEFS</h1>
            
      
      
      <div class="d-none name"><code>gefs-cog.Rmd</code></div>
    </div>

    
    
<p>In this vignette we take a look at assembling on-demand data cubes
from the NOAA Global Ensemble Forecast System which can be used as
driver data for forecasts anywhere in the world.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html" class="external-link">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>message<span class="op">=</span><span class="cn">FALSE</span>, warning<span class="op">=</span><span class="cn">FALSE</span>, fig.path <span class="op">=</span> <span class="st">"man/figures/"</span><span class="op">)</span></span></code></pre></div>
<p>In addition to this package (<code>gefs4cast</code>), this approach
relies heavily on the amazing and innovative work of
<code>gdalcubes</code>, as well as few commonly used packages.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/appelmar/gdalcubes_R" class="external-link">gdalcubes</a></span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">gefs4cast</span><span class="op">)</span> <span class="co"># remotes::install_github("neon4cast/gefs4cast")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridisLite/" class="external-link">viridisLite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap" class="external-link">tmap</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/gdalcubes_options.html" class="external-link">gdalcubes_options</a></span><span class="op">(</span>parallel <span class="op">=</span> <span class="fl">24</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="accessing-gefs-data">Accessing GEFS data<a class="anchor" aria-label="anchor" href="#accessing-gefs-data"></a>
</h2>
<p>First, we use <code>gefs4cast</code> to download the GEFS average
forecast for the next 10 days. While it is possible to download each of
the ensemble members individually, and also possible to access forecasts
up to 35 days in advance, this gives a nice dataset for experimentation
and illustrative purposes.</p>
<p>The raw data consists of one file every for every 3 hours over the
240 hour (10 day) forecast horizon, some 80 GRIB files in total, hosted
freely accessible on Amazon Web Services. Each file contains global
coverage for some <a href="">80 bands</a>, of which we access the
ground-height (2m or 10m) values for seven common variables.</p>
<p>In an idealized workflow, these files would be avialable in a
Cloud-optimized format like GeoTIFF and indexed in a STAC Catalog.
Meanwhile, <code>gefs4cast</code> takes on the responsibility of rapidly
downloading the desired bands while converting these GRIB files to local
GeoTIFF files using command-line <code>gdaltranslate</code> utilities in
parallel. This is quite fast, especially if significant bandwidth and
processing power are available, but reasonably crude.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-12-05"</span><span class="op">)</span> <span class="co">#Sys.Date()</span></span>
<span><span class="va">gefsdir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## 3-hr period up to 10 days, (then every 6 hrs up to 35 day horizon)</span></span>
<span><span class="fu"><a href="../reference/gefs_cog.html">gefs_cog</a></span><span class="op">(</span><span class="va">gefsdir</span>, ens_avg<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>         max_horizon<span class="op">=</span><span class="fl">240</span>, date <span class="op">=</span> <span class="va">date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">## 101.574  13.401   9.399</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="constructing-a-data-cube">Constructing a data cube<a class="anchor" aria-label="anchor" href="#constructing-a-data-cube"></a>
</h2>
<p>With our 80 files in hand, it is time to assemble them into a
multi-band “data cube”. We specify the datetimes by parsing the horizon
notation from the filename and the bands from the encoded file
metadata.</p>
<p>Given the band names and date range, we can use
<code>gdalcubes</code> to construct an image collection of all 79 assets
(note the horizon=0 file uses an incompatible band structure and is
omitted here).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 000 file has different bands and so cannot be stacked into the collection</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="va">gefsdir</span>, type<span class="op">=</span><span class="st">"file"</span>, recurse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">step</span> <span class="op">&lt;-</span> <span class="va">files</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="st">"f\\d{3}\\.tif"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="st">"\\d{3}"</span><span class="op">)</span> </span>
<span><span class="va">datetime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">hours</a></span><span class="op">(</span><span class="va">step</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># pull band names out with stars, hack the timestamp off of the band name</span></span>
<span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html" class="external-link">read_stars</a></span><span class="op">(</span><span class="va">files</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">bandnames</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_get_dimension_values</a></span><span class="op">(</span><span class="va">fc</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="st">"([A-Z]+):"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="st">":"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gefs_cube</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/create_image_collection.html" class="external-link">create_image_collection</a></span><span class="op">(</span><span class="va">files</span>,</span>
<span>                                     date_time <span class="op">=</span> <span class="va">datetime</span>, </span>
<span>                                     band_names <span class="op">=</span> <span class="va">bandnames</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="constructing-a-cube-view">Constructing a cube view<a class="anchor" aria-label="anchor" href="#constructing-a-cube-view"></a>
</h2>
<p>Second, we can create an entirely abstract “cube view” representing
our desired spatial and temporal resolution. For the moment, we simply
use the full time and space range of the assets, as well as the original
0.5 degree spatial resolution <code>dx</code>,<code>dy</code> and 3 hour
temporal resolution (<code>dt = "PT3H"</code>, in ISO Period
notation).</p>
<p>A <strong>crucial</strong> observation here, as we shall soon see, is
that we are by no means obligated to stick with either the projection,
the spatial/temporal extent or resolution of the data itself – we can
ask for whatever we want in defining this abstract box!</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">box</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span>
<span><span class="va">iso</span> <span class="op">&lt;-</span><span class="st">"%Y-%m-%dT%H:%M:%S"</span></span>
<span><span class="va">ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>t0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">datetime</span><span class="op">)</span>,<span class="va">iso</span><span class="op">)</span>, </span>
<span>              t1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">datetime</span><span class="op">)</span>,<span class="va">iso</span><span class="op">)</span>,</span>
<span>              left <span class="op">=</span> <span class="va">box</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, right <span class="op">=</span> <span class="va">box</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>              top <span class="op">=</span> <span class="va">box</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, bottom <span class="op">=</span> <span class="va">box</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/cube_view.html" class="external-link">cube_view</a></span><span class="op">(</span>srs <span class="op">=</span> <span class="st">"EPSG:4326"</span>, </span>
<span>               extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>              dx <span class="op">=</span> <span class="fl">0.5</span>, dy <span class="op">=</span> <span class="fl">0.5</span>, <span class="co"># original resolution -- half-degree</span></span>
<span>              dt <span class="op">=</span> <span class="st">"PT3H"</span>,   <span class="co"># original resolution</span></span>
<span>               aggregation <span class="op">=</span> <span class="st">"mean"</span>, resampling <span class="op">=</span> <span class="st">"cubicspline"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>It is worth thinking about each of these elements for a moment</p>
<ul>
<li><p><strong>Projection</strong>. This one is perhaps most obvious.
Specifying the projection is not only a way to define the units which
our box boundaries are specified in, our data will also be transformed
automatically into whatever projection we select. This is much better
than typical manual tooling that expects us to re-project. Projections
can be given as EPSG codes or full WKT strings.</p></li>
<li><p><strong>Extent</strong> We are free to set an extent in space or
time that is larger or smaller than our data. Intuitively, setting a
smaller range in space or time allows us to subset our original
collection in that way. Setting a larger spatial or temporal extent than
the data covers will introduce missing values.</p></li>
<li><p><strong>Resolution</strong> Resolution is perhaps the least
obvious and most magical.<br>
First, we could choose to set a resolution in space, that is coarser
than the underlying data, e.g. <code>dx=1.0</code> and
<code>dy=1.0</code>. In such cases, the data will be automatically
coarse-grained for us. This can be especially useful when generating
large-spatial scale analyses from fine-scale data (e.g. continental
scale analyses from high resolution imagery like Sentinel-2). Perhaps
more remarkably, we can also request a resolution that is <em>finer</em>
than the data itself: e.g. <code>dx=0.25, dy=0.25</code>, or even finer.
In these cases, the data products will be automatically re-sampled to
interpolate finer-scale pixel values (using <code>gdalwarp</code> under
the hood). A variety of resampling algorithms are possible, from
simplest (nearest neighbor) to richer methods like cubic splines. The
<code>resampling</code> argument specifies the algorithm for how pixels
are resampled across space to achieve the desired resolution.</p></li>
<li><p><strong>Temporal Resolution</strong>: Just as we can set
resolution in space, we can also choose a resolution in time. Here, we
have specified a the 3-hour interval, matching the data. If we specify a
coarser interval, multiple images covering the same pixels during that
interval will be aggregated. If we specify a finer time interval than
the data, the intermediate intervals are not automatically filled in by
algorithm, but are treated as missing data. We can later fill these in
through interpolation using the <code><a href="https://rdrr.io/pkg/gdalcubes/man/fill_time.html" class="external-link">fill_time()</a></code>
method.</p></li>
</ul>
<p>With GEFS, each single asset file represents spatial coverage of the
whole globe, and no pixels are obscured by clouds or otherwise missing
measurements. With other remote sensing products, our collection may
consist of a mosaic of interlocking or even overlapping tiles. Such
mosiacs work equally well, with an optional <code>mask</code> argument
allowing bad pixels such as cloud cover to be removed, and then
automatically filled in by the aggregation method from any overlapping
images within the specified time interval.</p>
</div>
<div class="section level2">
<h2 id="applying-our-cube-view-to-the-gefs-data">Applying our cube view to the GEFS data<a class="anchor" aria-label="anchor" href="#applying-our-cube-view-to-the-gefs-data"></a>
</h2>
<p>Let’s take a look at the temperature data cube now. Animations
provide a natural way to visualize spatio-temporal data, and are easy to
produce. All <code>gdalcubes</code> calculations are lazy-evaluated, so
that calculations are done only when necessary and only at the
resolution required for the operation. Crucially, calculations are also
entirely streaming, and thus require very little RAM despite the often
masssive scale of the data sets involved.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/raster_cube.html" class="external-link">raster_cube</a></span><span class="op">(</span><span class="va">gefs_cube</span>, <span class="va">v</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">gdalcubes</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/select_bands.html" class="external-link">select_bands</a></span><span class="op">(</span><span class="st">"TMP"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/animate.html" class="external-link">animate</a></span><span class="op">(</span> col <span class="op">=</span> <span class="fu">viridisLite</span><span class="fu">::</span><span class="va"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span>, nbreaks<span class="op">=</span><span class="fl">100</span>,</span>
<span>           fps<span class="op">=</span><span class="fl">10</span>, save_as <span class="op">=</span> <span class="st">"temp.gif"</span><span class="op">)</span></span></code></pre></div>
<p><img src="temp.gif"></p>
<p>Because the <code>cube_view</code> specification is completely
<strong>abstract</strong> and distinct from the data assets, we can
easily define a desired cube view that we reuse across a wide variety of
data sources – from GEFS to MODIS to Sentinel etc, extracting data in
identical spatio-temporal extents and resolutions.<br>
The necessary CRS transforms, cropping, coarse-graining or downscaling,
averaging or interpolating is all baked into the abstraction and handled
in parallelized and high-performance operations behind the scenes.</p>
<p>Downward Shortwave Radiation Flux is a good way to see what parts of
the globe are in day and night:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/raster_cube.html" class="external-link">raster_cube</a></span><span class="op">(</span><span class="va">gefs_cube</span>, <span class="va">v</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">gdalcubes</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/select_bands.html" class="external-link">select_bands</a></span><span class="op">(</span><span class="st">"DSWRF"</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/animate.html" class="external-link">animate</a></span><span class="op">(</span> col <span class="op">=</span> <span class="fu">viridisLite</span><span class="fu">::</span><span class="va"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span>, nbreaks<span class="op">=</span><span class="fl">100</span>, </span>
<span>           fps<span class="op">=</span><span class="fl">2</span>, save_as <span class="op">=</span> <span class="st">"dswrf.gif"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "/home/cboettig/eco4cast/gefs4cast/vignettes/dswrf.gif"</span></span></code></pre>
<p><img src="dswrf.gif"></p>
</div>
<div class="section level2">
<h2 id="downscaling-to-finer-resolution">Downscaling to finer resolution<a class="anchor" aria-label="anchor" href="#downscaling-to-finer-resolution"></a>
</h2>
<p>GEFS predictions are relatively coarse in space. For EFI terrestrial
forecast, finer temporal scales may also be desirable, such as for
driving the 30min terrestrial forecast. Let us thus consider a finer
spatial and temporal scale in our view. Further, we need not consider
the full global extent of the data. For illustrative purposes, lets
focus on a much smaller but still considerable spatial scale of the
northeastern US. We define two views of this area, one at the original
resolution and the other at finer spatial resolution. (While it is
possible to use a finer temporal resolution as well, as shown, this is
not necessary – temporal interpolation does not happen automatically,
and we can perform this step on the fly later on.)</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">box</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">75</span>, <span class="fl">40</span>, <span class="op">-</span><span class="fl">70</span>, <span class="fl">44</span><span class="op">)</span></span>
<span><span class="va">ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>t0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">datetime</span><span class="op">)</span>,<span class="va">iso</span><span class="op">)</span>, </span>
<span>             t1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">datetime</span><span class="op">)</span>,<span class="va">iso</span><span class="op">)</span>,</span>
<span>             left <span class="op">=</span> <span class="va">box</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, right <span class="op">=</span> <span class="va">box</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>             top <span class="op">=</span> <span class="va">box</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, bottom <span class="op">=</span> <span class="va">box</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">v_orig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/cube_view.html" class="external-link">cube_view</a></span><span class="op">(</span>srs <span class="op">=</span> <span class="st">"EPSG:4326"</span>,</span>
<span>                    extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                    dx <span class="op">=</span> <span class="fl">0.5</span>, dy <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                    dt <span class="op">=</span> <span class="st">"PT3H"</span>,</span>
<span>                    aggregation <span class="op">=</span> <span class="st">"mean"</span>, </span>
<span>                    resampling <span class="op">=</span> <span class="st">"cubicspline"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="va">v_fine</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/cube_view.html" class="external-link">cube_view</a></span><span class="op">(</span>srs <span class="op">=</span> <span class="st">"EPSG:4326"</span>,</span>
<span>                    extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                    dx <span class="op">=</span> <span class="fl">0.1</span>, dy <span class="op">=</span> <span class="fl">0.1</span>, </span>
<span>                    dt <span class="op">=</span> <span class="st">"PT30M"</span>,</span>
<span>                    aggregation <span class="op">=</span> <span class="st">"mean"</span>, </span>
<span>                    resampling <span class="op">=</span> <span class="st">"cubicspline"</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>For reference, let’s first see what the raw data looks like at this
level:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">datetime</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, <span class="va">iso</span><span class="op">)</span></span>
<span><span class="va">t</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "2022-12-09T09:00:00"</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/raster_cube.html" class="external-link">raster_cube</a></span><span class="op">(</span><span class="va">gefs_cube</span>, <span class="va">v_orig</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu">gdalcubes</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/select_bands.html" class="external-link">select_bands</a></span><span class="op">(</span><span class="st">"TMP"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/slice_time.html" class="external-link">slice_time</a></span><span class="op">(</span>datetime <span class="op">=</span> <span class="va">t</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html" class="external-link">st_as_stars</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_raster.html" class="external-link">tm_raster</a></span><span class="op">(</span>palette<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                          legend.show<span class="op">=</span><span class="cn">FALSE</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="fu">spData</span><span class="fu">::</span><span class="va"><a href="https://jakubnowosad.com/spData/reference/us_states.html" class="external-link">us_states</a></span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_polygons</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0</span>, border.col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="tmap_orig-1.png" alt=""><p class="caption">plot of chunk tmap_orig</p>
</div>
</div>
<div class="section level2">
<h2 id="temporal-interpolation">Temporal interpolation<a class="anchor" aria-label="anchor" href="#temporal-interpolation"></a>
</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/raster_cube.html" class="external-link">raster_cube</a></span><span class="op">(</span><span class="va">gefs_cube</span>, <span class="va">v_fine</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu">gdalcubes</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/select_bands.html" class="external-link">select_bands</a></span><span class="op">(</span><span class="st">"TMP"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/slice_time.html" class="external-link">slice_time</a></span><span class="op">(</span>datetime <span class="op">=</span> <span class="va">t</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html" class="external-link">st_as_stars</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_raster.html" class="external-link">tm_raster</a></span><span class="op">(</span>palette<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                          legend.show<span class="op">=</span><span class="cn">FALSE</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="fu">spData</span><span class="fu">::</span><span class="va"><a href="https://jakubnowosad.com/spData/reference/us_states.html" class="external-link">us_states</a></span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_polygons</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0</span>, border.col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="tmap_fine-1.png" alt=""><p class="caption">plot of chunk tmap_fine</p>
</div>
<p>Temporal interpolation is not performed by default, but we can
interpolate data to an arbitrarily finer timescale. (Note that if we did
not <code><a href="https://rdrr.io/pkg/gdalcubes/man/fill_time.html" class="external-link">fill_time()</a></code>, the result would be all-missing temp data.
Meanwhile, also note we can ask for an arbitrarily fine time scale here,
and do so on the <code>v_orig</code> data as well.)</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># an intermediate time:</span></span>
<span><span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_datetime</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">minutes</a></span><span class="op">(</span><span class="fl">30</span><span class="op">)</span>,  <span class="va">iso</span><span class="op">)</span></span>
<span><span class="va">t2</span> </span></code></pre></div>
<pre><code><span><span class="co">## [1] "2022-12-09T09:30:00"</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/raster_cube.html" class="external-link">raster_cube</a></span><span class="op">(</span><span class="va">gefs_cube</span>, <span class="va">v_fine</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu">gdalcubes</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/select_bands.html" class="external-link">select_bands</a></span><span class="op">(</span><span class="st">"TMP"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu">gdalcubes</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/fill_time.html" class="external-link">fill_time</a></span><span class="op">(</span><span class="st">"linear"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/slice_time.html" class="external-link">slice_time</a></span><span class="op">(</span>datetime <span class="op">=</span> <span class="va">t2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html" class="external-link">st_as_stars</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_raster.html" class="external-link">tm_raster</a></span><span class="op">(</span>palette<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                          legend.show<span class="op">=</span><span class="cn">FALSE</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="fu">spData</span><span class="fu">::</span><span class="va"><a href="https://jakubnowosad.com/spData/reference/us_states.html" class="external-link">us_states</a></span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html" class="external-link">tm_polygons</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0</span>, border.col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span></span></code></pre></div>
<p><img src="tmap_time-1.png"></p>
</div>
<div class="section level2">
<h2 id="extracting-values">Extracting values<a class="anchor" aria-label="anchor" href="#extracting-values"></a>
</h2>
<p>As illustrated in these examples, any data cube can be coerced into a
stars object, and we can use all the classic manipulation techniques
available in stars, e.g. to extract values at particular set of spatial
points over all time. We then use classic tidyverse to pivot the
resulting array into a simple data.frame of <code>site_id</code>,
<code>datetime</code>, <code>predicted</code>, and <code>variable</code>
for the chosen reference datetime here.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sites</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/neon_coordinates.html">neon_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"site_id"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span>, crs<span class="op">=</span><span class="st">"EPSG:4326"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/raster_cube.html" class="external-link">raster_cube</a></span><span class="op">(</span><span class="va">gefs_cube</span>, <span class="va">v</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/extract_geom.html" class="external-link">extract_geom</a></span><span class="op">(</span><span class="va">sites</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/pkg/gdalcubes/man/extract_geom.html" class="external-link">extract_geom()</a></code> returns a data.frame with columns for
time, feature ID (<code>FID</code>, i.e. row-number matching the polygon
for the site), and columns for each band. We can easily pivot this into
Ecological Forecasting Initiative (EFI) format.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="va">sites</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rowid_to_column</a></span><span class="op">(</span>var<span class="op">=</span><span class="st">"FID"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">FID</span>, <span class="op">-</span><span class="va">geometry</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">time</span>, <span class="op">-</span><span class="va">site_id</span><span class="op">)</span>, </span>
<span>               names_to<span class="op">=</span><span class="st">"variable"</span>, </span>
<span>               values_to<span class="op">=</span><span class="st">"prediction"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 6 × 4</span></span>
<span><span class="co">##   site_id time                variable prediction</span></span>
<span><span class="co">##   &lt;chr&gt;   &lt;chr&gt;               &lt;chr&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 LIRO    2022-12-10T15:00:00 APCP            0  </span></span>
<span><span class="co">## 2 LIRO    2022-12-10T15:00:00 DLWRF         185. </span></span>
<span><span class="co">## 3 LIRO    2022-12-10T15:00:00 DSWRF          37.2</span></span>
<span><span class="co">## 4 LIRO    2022-12-10T15:00:00 PRES        96120. </span></span>
<span><span class="co">## 5 LIRO    2022-12-10T15:00:00 RH             76.3</span></span>
<span><span class="co">## 6 LIRO    2022-12-10T15:00:00 TMP           -10.1</span></span></code></pre>
<p>Working directly with the gdalcube however, we can already also
perform much richer calculations with <code>reduce_time</code>,
<code>reduce_space</code>, <code>pixel_apply</code>,
<code>chunk_apply</code> and other functions of the gdalcubes
packages.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Carl Boettiger, Quinn Thomas.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
